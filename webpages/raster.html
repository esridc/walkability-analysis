<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Walkability Raster Test Page</title>

  <!-- Esri JS API + CSS-->
  <link rel="stylesheet" href="https://js.arcgis.com/4.8/esri/css/main.css">
  <script src="https://js.arcgis.com/4.8/"></script>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 90%;
      width: 100%;
    }
 </style>
</head>

<body>
  <div id="viewDiv"></div>
  <div class="col-lg-4">
  <form id="form">
    <label for="address">Address</label>
      <div class="input-group">
        <input type="text" class="form-control" id="address" length=80 placeholder="1600 Pennsylvania Ave NW">
        <span class="input-group-btn">
          <button type="button" id="submit" class="btn btn-primary">Calculate</button>
        </span>
      </div>

  </form>
  </div>
  <div id="stats" class="col-lg-6">

    <h1><p class="label label-primary" id="point-wb">Location: </p></h1>
    <!-- <h1><p class="label label-primary" id="neighborhood-wb">Neighborhood: </p></h1> -->

    <h1><p class="label label-default" id="city-wb">DC City Score: </p></h1>
  </div>

</body>


<script>
    var mean_city;
    require([
        "esri/Map",
        "esri/views/SceneView",
        "esri/geometry/Geometry",
        "esri/symbols/SimpleMarkerSymbol",
        "esri/Graphic",
        "esri/geometry/Point",
        "esri/layers/TileLayer",
        "esri/layers/FeatureLayer",
        "esri/renderers/smartMapping/statistics/summaryStatistics",
        "esri/PopupTemplate",
        "esri/tasks/Locator",
        "dojo/dom",
        "dojo/on",
        "dojo/domReady!"
      ],
      function(
        Map, SceneView, Geometry, SimpleMarkerSymbol, Graphic, Point, TileLayer, FeatureLayer, summaryStatistics, PopupTemplate, Locator, dom, on
      ) {
        /*raster layer showing walkability of DC*/


        var scoreLayer = new FeatureLayer({
          url: "https://services.arcgis.com/bkrWlSKcjUDFDtgw/arcgis/rest/services/DC_WalkRasterPoints/FeatureServer/0",
          id: "score-layer",
          opacity: 0.0,
        outFields: ["*"]
        });

        summaryStatistics({
            layer: scoreLayer,
            field: "percentile"
        }).then(function(stats){
            console.log(stats.avg)
                mean_city = (stats.avg * 100).toFixed(0);
                document.getElementById('city-wb').textContent =  "DC City Score: " + mean_city;
              }, function(error){
            console.error(error);
        });



        // scoreLayer.popupTemplate = { // autocasts as new PopupTemplate()
        //   title: "<font color='#008000'>Walkability Score:",
        //   content: [{
        //     // popup with score
        //     type: "fields",
        //     fieldInfos: [{
        //       fieldName: "percentile",
        //       visible: true,
        //       label: "At this location: "
        //     }]
        //   }],
        // };

        var walkableLayer = new TileLayer({
          url: "https://tiles.arcgis.com/tiles/bkrWlSKcjUDFDtgw/arcgis/rest/services/DC_WalkRaster/MapServer",
          id: "walk-layer",
          opacity: 0.9
        });
        var nbrhdLayer = new FeatureLayer({
          url: "https://maps2.dcgis.dc.gov/dcgis/rest/services/DCGIS_DATA/Administrative_Other_Boundaries_WebMercator/MapServer/17",
          id: "nbrhd-layer",
          opacity: 0.9
        });
        /*init the map and load layers*/
        var map = new Map({
          basemap: "oceans",
          layers: [walkableLayer, nbrhdLayer],
          center: [38.9072, 77.0369]
        });

        /*init view and set the view to go to the raster's extent when loaded*/
        var view = new SceneView({
          container: "viewDiv",
          map: map,
          popup: {
          dockEnabled: true,
          dockOptions: {
            buttonEnabled: false,
            breakpoint: false
          }
        }
        });

        view.when(function() {
          walkableLayer.when(function() {
            view.goTo(walkableLayer.fullExtent);
          });
        });

      /*listener for when the button is clicked - execute geocoding*/
      document.getElementById('submit').addEventListener('click', function() {
        var address = document.getElementById('address').value;
        // Only find locations where we have a walkScore
        var extent = walkableLayer.fullExtent;

        geocodeAddress(address, extent).then(function(results) {
          var location = results[0].location;
            //create the point and add it to the view
            var point = new Point(location.longitude, location.latitude);
            var symbol = new SimpleMarkerSymbol();
            var graphic = new Graphic(point, symbol);
            view.graphics.add(graphic);
            view.goTo({
              target: graphic,
              zoom: 15
            });
            calculateScore(location).then(function(walkScore) {
              var displayScore = (walkScore * 100).toFixed(0);
              document.getElementById('point-wb').textContent =  address + ": " + displayScore;
            }).catch(function(error){
              console.error("calculateScore error", error)
            })

          }).catch(function(error) {
            console.log("Geocoding error: ", error);
          });
      });

      function calculateScore(location) {
        var query = scoreLayer.createQuery();
        query.geometry = location;  // the point location of the pointer
        // var percentAverage = {
        //   onStatisticField: "percentile",  // service field for 2015 population
        //   outStatisticFieldName: "percentileAverage",
        //   statisticType: "avg"
        // };
        // query.outStatistics = [ percentAverage ];
        query.distance = 100;
        query.units = "meters";
        return scoreLayer.queryFeatures(query).then(function(response){
           var percentileAverage = 0;
           response.features.forEach(function(feature) {
             percentileAverage += feature.attributes.percentile;
           })
           percentileAverage /= response.features.length;

           var func = new Promise(function(resolve, error) {
             resolve(percentileAverage)
           })
           return func;
         }).catch(function(error) {
           console.error("calculateScore error", error)
         })
      }

      /*geocode the input address and plot a point on the map*/
      function geocodeAddress(address, extent) {
        // var geocoder = new google.maps.Geocoder();
        var geocoder = new Locator({
          url: "http://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer"
        });
        return geocoder.addressToLocations({address: {"singleLine": address}, searchExtent: extent});
      }

    });
  </script>
</html>
